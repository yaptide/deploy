# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html
- name: Git checkout
  ansible.builtin.git:
    repo: 'https://github.com/yaptide/yaptide'
    dest: '{{ backend_repo_workdir }}'
    version: '{{ backend_repo_version }}'
    force: true  # at later stages repo can be manually modified, therefore we do a force checkout

# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
- name: Copy shieldhit binary to the backend instance
  ansible.builtin.copy:
    src: shieldhit
    dest: '{{ backend_repo_workdir }}'
    mode: '0750'

# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
- name: Create a file with environment variables, needed by docker-compose
  ansible.builtin.copy:
    dest: '{{ backend_repo_workdir }}/.env'
    mode: '0640'
    content: 'SHIELDHIT_PATH: {{ backend_repo_workdir }}/shieldhit'

# https://docs.ansible.com/ansible/latest/collections/community/docker/docker_compose_module.html
- name: Run `docker-compose up` to bring up the backend
  community.docker.docker_compose:
    project_src: '{{ backend_repo_workdir }}'

- name: Insert a first user into database
  community.docker.docker_container_exec:
    container: yaptide_flask
    command: 'python3 yaptide/admin/db_manage.py add-user admin --password {{ backend_password }}'
    chdir: /usr/local/app/
  register: add_user_output

- name: Print output of add-user command
  ansible.builtin.debug:
    msg: '{{ add_user_output.stdout_lines }}'
