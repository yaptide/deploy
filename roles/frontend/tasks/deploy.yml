# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html
- name: Git checkout
  ansible.builtin.git: # noqa: latest
    repo: 'https://github.com/yaptide/ui'
    dest: '{{ frontend_repo_workdir }}'
    version: '{{ frontend_repo_version }}'

- name: Print build information
  ansible.builtin.debug:
    msg: "Building for backend http://{{ frontend_backend_hostname }}:5000"

- name: Create .env file with REACT_APP_BACKEND_URL
  ansible.builtin.blockinfile:
    path: '{{ frontend_repo_workdir }}/.env'
    mode: '0640'
    create: true
    block: |
      REACT_APP_BACKEND_URL = http://{{ frontend_backend_hostname }}:5000

# https://docs.ansible.com/ansible/latest/collections/community/docker/docker_image_module.html
# equivalent of:
# REACT_APP_BACKEND_URL=http://149.156.182.181:5000  docker build -t ui .
# this may be a time consuming task
- name: Build image
  community.docker.docker_image:
    name: ui
    build:
      path: '{{ frontend_repo_workdir }}'
    source: build

# https://docs.ansible.com/ansible/latest/collections/community/docker/docker_container_module.html
- name: Serve frontend app
  community.docker.docker_container:
    name: ui
    image: ui
    state: started
    published_ports:
      - '0.0.0.0:80:80'
  register: frontend_build_app_output

- name: Print output of frontend_build_app_output
  ansible.builtin.debug:
    msg: "{{ frontend_build_app_output.container }}"

- name: Show where frontend is running
  ansible.builtin.debug:
    msg: "Yaptide platform is available at http://{{ frontend_ui_hostname }} "
