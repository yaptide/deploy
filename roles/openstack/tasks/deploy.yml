# # Show all available Openstack images
# - name: Retrieve all available Openstack images
#   openstack.cloud.image_info:
#   register: result

# - name: Show images
#   debug:
#      msg: "{{ item.name }}"
#   loop: "{{ result.openstack_images  }}"

# Old key needs to be deleted prior to creating a new one
# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/keypair_module.html
- openstack.cloud.keypair:
      state: absent
      name: "{{ key_name }}"

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/keypair_module.html
- openstack.cloud.keypair:
      state: present
      name: "{{ key_name }}"
      public_key_file: /home/grzanka/.ssh/id_rsa.pub

# - name: Get information about keypairs
#   openstack.cloud.keypair_info:
#   register: result

# - name: Show keypairs
#   debug:
#      msg: "{{ item.name }}"
#   loop: "{{ result.openstack_keypairs  }}"

# # Gather information about all available flavors
# - openstack.cloud.compute_flavor_info:
#   register: result

# - debug:
#     msg: "{{ result.openstack_flavors }}"

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/network_module.html
- name: Create the network
  os_network:
    state: present
    name: "{{ network_name }}"
  register: network_facts

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/subnet_module.html
- name: Create the subnet
  os_subnet:
    state: present
    network_name: "{{ network_facts.id }}"
    name: "{{ subnet_name }}"
    ip_version: 4
    cidr: "{{ subnet_cidr }}"
    gateway_ip: "{{ gateway_ip }}"
    enable_dhcp: yes
    dns_nameservers: "{{ dns_nameservers }}"
  register: subnet_facts

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/router_module.html
- name: Create the router
  os_router:
    state: present
    name: "{{ router_name }}"
    network: "{{ external_network_name }}"
    interfaces:
      - "{{ subnet_name }}"

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/security_group_module.html
- name: Create a new security group
  os_security_group:
    state: present
    name: "{{ security_group_name }}"

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/security_group_rule_module.html  
- name: Create a new security group allowing any ICMP
  os_security_group_rule:
    security_group: "{{ security_group_name }}"
    protocol: icmp
    remote_ip_prefix: 0.0.0.0/0

# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/security_group_rule_module.html
- name: Create a new security group allowing any SSH connection
  os_security_group_rule:
    security_group: "{{ security_group_name }}"
    protocol: tcp
    port_range_min: 22
    port_range_max: 22
    remote_ip_prefix: 0.0.0.0/0

# Create a new instance
# https://docs.ansible.com/ansible/latest/collections/openstack/cloud/server_module.html
- name: launch an instance
  openstack.cloud.server:
    state: present
    name: "{{ instance_hostname }}"
    image: "{{ image_name }}"
    key_name: "{{ key_name }}"
    flavor: "{{ flavor_name }}"
    nics:
      - net-name: "{{ network_name }}"
    security_groups: "{{ security_group_name }}"
    auto_ip: yes
  register: instance_facts

- name: Show Server's IP
  debug: 
    msg: "{{ instance_facts.openstack_server.accessIPv4 }}"
      #var=instance_facts.openstack.public_v4